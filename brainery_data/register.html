{% extends "base.html" %}

{% block content %}

<style>
    /* =======================================================
   REGISTER PAGE
   ======================================================= */

    /* -------------------------------
   Global Resets
   ------------------------------- */
    /* Reset default margins and paddings */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Arial', sans-serif;
    }

    /* Body Styling */
    body {
        background: #f8f9fa;
    }

    /* -------------------------------
   Page Layout
   ------------------------------- */
    /* Page container for register form */
    .register-container {
        max-width: 700px;
        margin: 50px auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    /* Smooth fade-in effect */
    .register-container.show {
        opacity: 1;
        transform: translateY(0);
    }

    .register-container.hidden {
        opacity: 0;
        transform: translateY(-10px);
    }

    /* -------------------------------
   Titles
   ------------------------------- */
    /* Register Page Title */
    .register-container h2 {
        font-weight: bold;
        margin-bottom: 20px;
    }

    /* -------------------------------
   Package Selection Layout
   ------------------------------- */
    /* Package selection container */
    .package-selection {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    /* -------------------------------
   Package Cards
   ------------------------------- */
    /* Individual package card */
    .package {
        flex: 1;
        padding: 20px;
        background: #fff;
        border: 2px solid #20c997;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        min-width: 200px;
        position: relative;
    }

    /* Hover effect & selection */
    .package:hover,
    .package.selected {
        background: #20c997;
        color: white;
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.2);
    }

    /* Small pulse effect when selected */
    .package.selected::after {
        content: "âœ”";
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        font-weight: bold;
        color: white;
    }

    /* -------------------------------
   Form Sections
   ------------------------------- */
    /* Smooth fade-in effect */
    .step-section {
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
    }

    .step-section.active {
        display: block;
        opacity: 1;
    }

    /* -------------------------------
   Form Input Fields
   ------------------------------- */
    /* Form group wrapper */
    .form-group {
        margin-bottom: 15px;
        position: relative;
    }

    /* Input Labels */
    label {
        font-weight: bold;
        display: block;
    }

    /* Input Fields */
    input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        transition: border 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }

    /* Input focus effect */
    input:focus {
        border-color: #20c997;
        box-shadow: 0px 0px 8px rgba(32, 201, 151, 0.3);
        outline: none;
    }

    /* -------------------------------
   Payment Section
   ------------------------------- */
    /* Smooth fade-in effect */
    .payment-section {
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
    }

    .payment-section.active {
        display: block;
        opacity: 1;
    }

    /* -------------------------------
   Promo Code Section
   ------------------------------- */
    /* Promo code input */
    .promo-code input {
        width: 70%;
        display: inline-block;
    }

    /* Promo code apply button */
    .promo-code button {
        width: 28%;
        background: #20c997;
        color: white;
        border: none;
        padding: 8px;
        cursor: pointer;
        transition: background 0.3s ease-in-out;
    }

    /* Hover effect */
    .promo-code button:hover {
        background: #198754;
    }

    /* Promo Message */
    #promo-message {
        margin-top: 5px;
        font-size: 14px;
        transition: opacity 0.3s ease-in-out, color 0.3s ease-in-out;
    }

    /* -------------------------------
   All Button
   ------------------------------- */
    /* Main submit button */
    .submit-btn {
        background: #20c997;
        color: white;
        border: none;
        padding: 12px;
        width: 100%;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        border-radius: 5px;
        transition: background 0.3s ease-in-out, transform 0.2s ease-in-out;
    }

    /* Hover effect */
    .submit-btn:hover {
        background: #198754;
        transform: scale(1.02);
    }

    /* Click effect */
    .submit-btn:active {
        transform: scale(0.98);
    }

    /* Loading Spinner for Button */
    .spinner {
        width: 15px;
        height: 15px;
        border: 2px solid white;
        border-top-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spin 0.6s linear infinite;
        margin-right: 5px;
    }

    /* Spinner for Button */
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Style for next button - matching submit button */
    .next-btn {
        background: #20c997;
        /* Same color as submit button */
        color: white;
        border: none;
        padding: 12px;
        width: 100%;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        border-radius: 5px;
        transition: background 0.3s ease-in-out, transform 0.2s ease-in-out;
    }

    /* Hover effect */
    .next-btn:hover {
        background: #198754;
        /* Darker shade for hover */
        transform: scale(1.02);
    }

    /* Click effect */
    .next-btn:active {
        transform: scale(0.98);
    }

    /* -------------------------------
   Step Sections - Smooth Transitions
   ------------------------------- */
    .step-section {
        display: none;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    }

    /* Active step - Fades in smoothly */
    .step-section.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    /* -------------------------------
   Funny Success Message
   ------------------------------- */
    /* Initially hidden */
    .success-message {
        display: none;
        opacity: 0;
        transform: scale(0.9);
        transition: opacity 0.5s ease-in-out, transform 0.4s ease-in-out;
    }

    /* When shown, smoothly appears */
    .success-message.show {
        display: block;
        opacity: 1;
        transform: scale(1);
    }

    /* -------------------------------
   Mobile & Tablet View (Responsive)
   ------------------------------- */
    /* Adjust Navbar for Mobile (screens smaller than 768px) */
    @media (max-width: 768px) {
        .register-container {
            max-width: 95%;
            padding: 20px;
        }

        .package-selection {
            flex-direction: column;
            gap: 10px;
        }

        .package {
            width: 100%;
        }

        input,
        select,
        textarea {
            font-size: 16px;
            padding: 12px;
        }

        .submit-btn {
            font-size: 14px;
            padding: 10px;
        }

        .step-section {
            width: 100%;
            padding: 20px;
        }

        .step-section.active {
            transform: translateY(0);
            opacity: 1;
        }

        input,
        select,
        textarea {
            font-size: 16px;
            padding: 12px;
        }

        .success-message {
            font-size: 18px;
            padding: 30px;
        }

        .register-container {
            padding: 15px;
        }

        h2 {
            font-size: 20px;
        }

        .submit-btn {
            font-size: 14px;
            padding: 10px;
        }

        .next-btn {
            font-size: 14px;
            padding: 10px;
        }

    }

    /* Adjust Navbar for Mobile (screens smaller than 576px) */
    @media (max-width: 480px) {
        .register-container {
            padding: 15px;
        }

        h2 {
            font-size: 22px;
        }

        .submit-btn {
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            font-size: 14px;
            padding: 10px;
        }

        .package-selection {
            flex-direction: column;
            gap: 10px;
        }

        .package {
            width: 100%;
        }

        .success-message {
            font-size: 16px;
            padding: 20px;
        }

        .next-btn {
            font-size: 13px;
            padding: 8px;
        }

    }
</style>



<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="flash-messages">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<!-- Register Page Container -->
<div class="register-container" id="register-form">
    <h2>Choose Your Brainery Plan</h2>

    <!-- Package Selection -->
    <div class="package-selection">
        <div class="package" data-price="10" data-name="Weekly Plan">
            <h4>Weekly Plan - Â£10</h4>
            <ul>
                <li>ðŸ“š Access to all courses</li>
                <li>ðŸ—“ 7-day validity</li>
                <li>ðŸ’¬ Community Support</li>
            </ul>
        </div>
        <div class="package" data-price="30" data-name="Monthly Plan">
            <h4>Monthly Plan - Â£30</h4>
            <ul>
                <li>ðŸ“š Access to all courses</li>
                <li>ðŸ—“ 30-day validity</li>
                <li>ðŸ’¬ Priority Support</li>
            </ul>
        </div>
        <div class="package" data-price="100" data-name="Annual Plan">
            <h4>Annual Plan - Â£100</h4>
            <ul>
                <li>ðŸ“š Access to all courses</li>
                <li>ðŸ—“ 1-year validity</li>
                <li>ðŸŽ“ Certification on Completion</li>
            </ul>
        </div>
    </div>

    <!-- âœ… Single Form for Multi-Step Registration -->
    <form method="POST" id="registration-form">
        {{ form.hidden_tag() }} <!-- âœ… CSRF Token (Only Once) -->
        <input type="hidden" id="selected_plan" name="selected_plan">

        <!-- Step 1: Personal Info -->
        <div id="personal-info" class="step-section">
            <h4>Tell us about yourself</h4>

            <div class="form-group">
                <label for="first_name">First Name</label>
                {{ form.first_name(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="last_name">Last Name</label>
                {{ form.last_name(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="dob">Date of Birth</label>
                {{ form.dob(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                {{ form.email(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="phone">Phone Number</label>
                {{ form.phone(class="form-control", required=True) }}
            </div>

            <h5>Billing Address</h5>
            <div class="form-group">
                <label for="address_line1">Address Line 1</label>
                {{ form.address_line1(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="city">City</label>
                {{ form.city(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="country">Country</label>
                {{ form.country(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="postcode">Postcode</label>
                {{ form.postcode(class="form-control", required=True) }}
            </div>

            <button type="button" class="next-btn" onclick="nextStep('personal-info', 'payment-info')">Next</button>
        </div>

        <!-- Step 2: Payment Info -->
        <div id="payment-info" class="step-section hidden">
            <h4>Enter Payment Details</h4>

            <div class="form-group">
                <label for="card_number">Card Number</label>
                <input type="text" name="card_number" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="expiry_date">Expiry Date</label>
                <input type="text" name="expiry_date" class="form-control" placeholder="MM/YY" required>
            </div>
            <div class="form-group">
                <label for="cvv">CVV</label>
                <input type="text" name="cvv" class="form-control" required>
            </div>

            <div class="form-group promo-code">
                <label for="promo-code">Promo Code (Optional)</label>
                <input type="text" id="promo-code" class="form-control" placeholder="Enter promo code">
                <button type="button" onclick="applyPromoCode()">Apply</button>
                <p id="promo-message"></p>
            </div>

            <button type="button" class="next-btn" onclick="nextStep('payment-info', 'password-info')">Next</button>
        </div>

        <!-- Step 3: Password Info -->
        <div id="password-info" class="step-section hidden">
            <h4>Set Your Account Password</h4>
            <div class="form-group">
                <label for="password">Password</label>
                {{ form.password(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="confirm_password">Confirm Password</label>
                {{ form.confirm_password(class="form-control", required=True) }}
            </div>

            <button type="submit" class="submit-btn">Complete Registration</button>
        </div>
    </form>

    <!-- Funny Success Message -->
    <div class="success-message hidden" id="success-message">
        <h2>ðŸŽ‰ Woohoo! Youâ€™re now officially part of the Brainery Family! ðŸŽ“</h2>
        <p>ðŸ“¬ Check your email for your account activation link.</p>
        <p>ðŸ¤– If you donâ€™t see it, maybe itâ€™s lost in the <strong>Matrix</strong> (or spam folder).</p>
        <p>ðŸš€ Happy Learning!</p>
    </div>
</div>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("âœ… JavaScript Loaded! Waiting for user interaction...");

        /* =======================================================
           SECTION 1: Element Selection & Validation
        ======================================================= */

        let packages = document.querySelectorAll(".package");
        let selectedPlanInput = document.getElementById("selected_plan");
        let personalInfo = document.getElementById("personal-info");
        let paymentForm = document.getElementById("payment-info");
        let passwordInfo = document.getElementById("password-info");
        let submitButton = document.querySelector("#password-info .submit-btn");
        let successMessage = document.getElementById("success-message");

        let csrfToken = document.querySelector('input[name="csrf_token"]')?.value; // âœ… Get CSRF Token

        // âœ… Ensure hidden input for selected plan exists
        if (!selectedPlanInput) {
            console.warn("âš ï¸ WARNING: Missing #selected_plan! Creating it...");
            selectedPlanInput = document.createElement("input");
            selectedPlanInput.type = "hidden";
            selectedPlanInput.id = "selected_plan";
            selectedPlanInput.name = "selected_plan";
            document.getElementById("personal-info").appendChild(selectedPlanInput);
            console.log("âœ… Created missing #selected_plan input field.");
        }

        /* =======================================================
           SECTION 2: Package Selection Handling
        ======================================================= */
        packages.forEach(package => {
            package.addEventListener("click", function () {
                console.log("ðŸ“¦ Package Selected:", this.dataset.name);

                // Remove 'selected' class from all packages
                packages.forEach(p => p.classList.remove("selected"));

                // Add 'selected' class to the clicked package
                this.classList.add("selected");

                // Update the hidden input field
                selectedPlanInput.value = `${this.dataset.name} - Â£${this.dataset.price}`;
                console.log("ðŸ“Œ Selected Plan:", selectedPlanInput.value);

                // Show the personal info form
                personalInfo.style.display = "block";
                setTimeout(() => { personalInfo.style.opacity = 1; }, 100);
                personalInfo.scrollIntoView({ behavior: "smooth" });
            });
        });

        /* =======================================================
           SECTION 3: Step Navigation & Validation (Next Button)
        ======================================================= */
        function nextStep(currentId, nextId) {
            let currentSection = document.getElementById(currentId);
            let nextSection = document.getElementById(nextId);

            if (!currentSection || !nextSection) {
                console.error("âŒ ERROR: Missing section IDs", currentId, nextId);
                return;
            }

            // âœ… Validate required fields before proceeding
            let requiredFields = currentSection.querySelectorAll("input[required]");
            let emptyFields = Array.from(requiredFields).filter(input => input.value.trim() === "");

            if (emptyFields.length > 0) {
                alert("âš ï¸ Please fill in all required fields before proceeding.");
                emptyFields.forEach(input => input.style.border = "2px solid red"); // Highlight missing fields
                emptyFields[0].focus();  // Focus on the first missing field
                return;
            }

            // âœ… Reset border for filled fields
            requiredFields.forEach(input => input.style.border = "");

            console.log(`ðŸ”„ Transitioning from ${currentId} to ${nextId}`);

            // Hide current section
            currentSection.style.opacity = 0;
            setTimeout(() => {
                currentSection.style.display = "none";

                // Show next section
                nextSection.style.display = "block";
                setTimeout(() => { nextSection.style.opacity = 1; }, 100);
                nextSection.scrollIntoView({ behavior: "smooth" });
            }, 200);
        }

        // âœ… Attach `nextStep` to global scope (so it works in inline HTML)
        window.nextStep = nextStep;

        /* =======================================================
           SECTION 4: Expiry Date Validation (03/25 and Onwards)
        ======================================================= */
        function validateExpiryDate(expiryDate) {
            let [month, year] = expiryDate.split("/").map(Number);
            let currentDate = new Date();
            let currentYear = currentDate.getFullYear() % 100; // Get last two digits of the year
            let currentMonth = currentDate.getMonth() + 1; // Get current month (1-12)

            // Enforce expiry date should be **March 2025 (03/25) or later**
            if (
                isNaN(month) || isNaN(year) || // Ensure valid numbers
                month < 1 || month > 12 || // Month should be between 01-12
                year < 25 || // Ensure year is 2025 or later
                (year === 25 && month < 3) // If year is 2025, month should be March (03) or later
            ) {
                return false;
            }

            return true;
        }

        /* =======================================================
           SECTION 5: Payment Form Submission & Validation
        ======================================================= */
        paymentForm.addEventListener("submit", function (event) {
            event.preventDefault();
            console.log("ðŸ’³ Processing Payment...");

            let promoCode = document.getElementById("promo-code")?.value.trim();
            let expiryDate = document.querySelector('input[name="expiry_date"]').value.trim();

            // âœ… If promo is NOT applied, validate payment fields
            if (promoCode !== "CI25MP3") {
                let cardNumber = document.querySelector('input[name="card_number"]').value.trim();
                let cvv = document.querySelector('input[name="cvv"]').value.trim();

                if (!/^\d{16}$/.test(cardNumber)) {
                    alert("âŒ Please enter a valid 16-digit card number.");
                    return;
                }

                if (!validateExpiryDate(expiryDate)) {
                    alert("âŒ Expiry date must be March 2025 (03/25) or later.");
                    return;
                }

                if (!/^\d{3,4}$/.test(cvv)) {
                    alert("âŒ Enter a valid 3-4 digit CVV.");
                    return;
                }
            }

            console.log("âœ… Payment Validated. Moving to Password Section...");
            nextStep("payment-info", "password-info");
        });

        /* =======================================================
           SECTION 6: CSRF Token Fix for Form Submission
        ======================================================= */
        document.querySelectorAll("form").forEach(form => {
            if (!form.querySelector('input[name="csrf_token"]')) {
                let csrfInput = document.createElement("input");
                csrfInput.type = "hidden";
                csrfInput.name = "csrf_token";
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                console.log("âœ… CSRF token added to form:", form.id);
            }
        });

        /* =======================================================
           SECTION 7: Promo Code Handling
        ======================================================= */
        function applyPromoCode() {
            const promoCodeInput = document.getElementById("promo-code")?.value.trim();
            const promoMessage = document.getElementById("promo-message");

            let cardNumber = document.querySelector('input[name="card_number"]');
            let expiryDate = document.querySelector('input[name="expiry_date"]');
            let cvv = document.querySelector('input[name="cvv"]');

            if (promoCodeInput === "CI25MP3") {
                promoMessage.innerText = "âœ… Promo applied! No payment required.";
                promoMessage.style.color = "green";

                [cardNumber, expiryDate, cvv].forEach(field => {
                    field.disabled = true;
                    field.style.backgroundColor = "#e9ecef";
                });

                submitButton.innerText = "Complete Registration";
                submitButton.disabled = false;
            } else {
                promoMessage.innerText = "âŒ Invalid promo code.";
                promoMessage.style.color = "red";

                [cardNumber, expiryDate, cvv].forEach(field => {
                    field.disabled = false;
                    field.style.backgroundColor = "";
                });

                submitButton.innerText = "Complete Registration";
            }
        }

        document.querySelector(".promo-code button")?.addEventListener("click", applyPromoCode);
    });
</script>

{% endblock %}