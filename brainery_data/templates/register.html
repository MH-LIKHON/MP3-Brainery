{% extends "base.html" %}

{% block content %}

<style>
    /* =======================================================
   REGISTER PAGE
   ======================================================= */

    /* -------------------------------
   Global Resets
   ------------------------------- */
    /* Reset default margins and paddings */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Arial', sans-serif;
    }

    /* Body Styling */
    body {
        background: #f8f9fa;
    }

    /* -------------------------------
   Page Layout
   ------------------------------- */
    /* Page container for register form */
    .register-container {
        max-width: 700px;
        margin: 50px auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    /* Smooth fade-in effect */
    .register-container.show {
        opacity: 1;
        transform: translateY(0);
    }

    .register-container.hidden {
        opacity: 0;
        transform: translateY(-10px);
    }

    /* -------------------------------
   Titles
   ------------------------------- */
    /* Register Page Title */
    .register-container h2 {
        font-weight: bold;
        margin-bottom: 20px;
    }

    /* -------------------------------
   Package Selection Layout
   ------------------------------- */
    /* Package selection container */
    .package-selection {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    /* -------------------------------
   Package Cards
   ------------------------------- */
    /* Individual package card */
    .package {
        flex: 1;
        padding: 20px;
        background: #fff;
        border: 2px solid #20c997;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        min-width: 200px;
        position: relative;
    }

    /* Hover effect & selection */
    .package:hover,
    .package.selected {
        background: #20c997;
        color: white;
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.2);
    }

    /* Small pulse effect when selected */
    .package.selected::after {
        content: "âœ”";
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        font-weight: bold;
        color: white;
    }

    /* -------------------------------
   Form Sections
   ------------------------------- */
    /* Smooth fade-in effect */
    .step-section {
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
    }

    .step-section.active {
        display: block;
        opacity: 1;
    }

    /* -------------------------------
   Form Input Fields
   ------------------------------- */
    /* Form group wrapper */
    .form-group {
        margin-bottom: 15px;
        position: relative;
    }

    /* Input Labels */
    label {
        font-weight: bold;
        display: block;
    }

    /* Input Fields */
    input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        transition: border 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }

    /* Input focus effect */
    input:focus {
        border-color: #20c997;
        box-shadow: 0px 0px 8px rgba(32, 201, 151, 0.3);
        outline: none;
    }

    /* -------------------------------
   Payment Section
   ------------------------------- */
    /* Smooth fade-in effect */
    .payment-section {
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
    }

    .payment-section.active {
        display: block;
        opacity: 1;
    }

    /* -------------------------------
   Promo Code Section
   ------------------------------- */
    /* Promo code input */
    .promo-code input {
        width: 70%;
        display: inline-block;
    }

    /* Promo code apply button */
    .promo-code button {
        width: 28%;
        background: #20c997;
        color: white;
        border: none;
        padding: 8px;
        cursor: pointer;
        transition: background 0.3s ease-in-out;
    }

    /* Hover effect */
    .promo-code button:hover {
        background: #198754;
    }

    /* Promo Message */
    #promo-message {
        margin-top: 5px;
        font-size: 14px;
        transition: opacity 0.3s ease-in-out, color 0.3s ease-in-out;
    }

    /* -------------------------------
   All Button
   ------------------------------- */
    /* Main submit button */
    .submit-btn {
        background: #20c997;
        color: white;
        border: none;
        padding: 12px;
        width: 100%;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        border-radius: 5px;
        transition: background 0.3s ease-in-out, transform 0.2s ease-in-out;
    }

    /* Hover effect */
    .submit-btn:hover {
        background: #198754;
        transform: scale(1.02);
    }

    /* Click effect */
    .submit-btn:active {
        transform: scale(0.98);
    }

    /* Loading Spinner for Button */
    .spinner {
        width: 15px;
        height: 15px;
        border: 2px solid white;
        border-top-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spin 0.6s linear infinite;
        margin-right: 5px;
    }

    /* Spinner for Button */
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Style for next button - matching submit button */
    .next-btn {
        background: #20c997;
        /* Same color as submit button */
        color: white;
        border: none;
        padding: 12px;
        width: 100%;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        border-radius: 5px;
        transition: background 0.3s ease-in-out, transform 0.2s ease-in-out;
    }

    /* Hover effect */
    .next-btn:hover {
        background: #198754;
        /* Darker shade for hover */
        transform: scale(1.02);
    }

    /* Click effect */
    .next-btn:active {
        transform: scale(0.98);
    }

    /* -------------------------------
   Step Sections - Smooth Transitions
   ------------------------------- */
    .step-section {
        display: none;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    }

    /* Active step - Fades in smoothly */
    .step-section.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    /* -------------------------------
   Funny Success Message
   ------------------------------- */
    /* Initially hidden */
    .success-message {
        display: none;
        opacity: 0;
        transform: scale(0.9);
        transition: opacity 0.5s ease-in-out, transform 0.4s ease-in-out;
    }

    /* When shown, smoothly appears */
    .success-message.show {
        display: block;
        opacity: 1;
        transform: scale(1);
    }

    /* -------------------------------
   Mobile & Tablet View (Responsive)
   ------------------------------- */
    /* Adjust Navbar for Mobile (screens smaller than 768px) */
    @media (max-width: 768px) {
        .register-container {
            max-width: 95%;
            padding: 20px;
        }

        .package-selection {
            flex-direction: column;
            gap: 10px;
        }

        .package {
            width: 100%;
        }

        input,
        select,
        textarea {
            font-size: 16px;
            padding: 12px;
        }

        .submit-btn {
            font-size: 14px;
            padding: 10px;
        }

        .step-section {
            width: 100%;
            padding: 20px;
        }

        .step-section.active {
            transform: translateY(0);
            opacity: 1;
        }

        input,
        select,
        textarea {
            font-size: 16px;
            padding: 12px;
        }

        .success-message {
            font-size: 18px;
            padding: 30px;
        }

        .register-container {
            padding: 15px;
        }

        h2 {
            font-size: 20px;
        }

        .submit-btn {
            font-size: 14px;
            padding: 10px;
        }

        .next-btn {
            font-size: 14px;
            padding: 10px;
        }

    }

    /* Adjust Navbar for Mobile (screens smaller than 576px) */
    @media (max-width: 480px) {
        .register-container {
            padding: 15px;
        }

        h2 {
            font-size: 22px;
        }

        .submit-btn {
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            font-size: 14px;
            padding: 10px;
        }

        .package-selection {
            flex-direction: column;
            gap: 10px;
        }

        .package {
            width: 100%;
        }

        .success-message {
            font-size: 16px;
            padding: 20px;
        }

        .next-btn {
            font-size: 13px;
            padding: 8px;
        }

    }
</style>



<!-- Flash Messages -->
{% if not show_success %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="flash-messages">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}
{% endif %}

<!-- Error Message Container -->
<div id="error-container" style="display: none; text-align: center; color: red; font-size: 1.2em; margin-bottom: 20px;">
</div>


<!-- âœ… Show Registration Form Only if Not Success -->
{% if not show_success %}
<div class="register-container" id="register-form">

    <h2>Choose Your Brainery Plan</h2>

    <!-- Package Selection -->
    <div class="package-selection">
        <div class="package" data-price="10" data-name="Weekly Plan">
            <h4>Weekly Plan - Â£10</h4>
            <ul>
                <li>ðŸ“š Access to all courses</li>
                <li>ðŸ—“ 7-day validity</li>
                <li>ðŸ’¬ Community Support</li>
            </ul>
        </div>
        <div class="package" data-price="30" data-name="Monthly Plan">
            <h4>Monthly Plan - Â£30</h4>
            <ul>
                <li>ðŸ“š Access to all courses</li>
                <li>ðŸ—“ 30-day validity</li>
                <li>ðŸ’¬ Priority Support</li>
            </ul>
        </div>
        <div class="package" data-price="100" data-name="Annual Plan">
            <h4>Annual Plan - Â£100</h4>
            <ul>
                <li>ðŸ“š Access to all courses</li>
                <li>ðŸ—“ 1-year validity</li>
                <li>ðŸŽ“ Certification on Completion</li>
            </ul>
        </div>
    </div>

    <!-- âœ… Multi-Step Registration Form -->
    <form method="POST" id="registration-form">
        {{ form.hidden_tag() }} <!-- âœ… CSRF Token -->
        <input type="hidden" id="selected_plan" name="selected_plan" required>

        <!-- Step 1: Personal Info -->
        <div id="personal-info" class="step-section">
            <h4>Tell us about yourself</h4>

            <div class="form-group">
                <label for="first_name">First Name</label>
                {{ form.first_name(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="last_name">Last Name</label>
                {{ form.last_name(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="dob">Date of Birth</label>
                {{ form.dob(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                {{ form.email(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="phone">Phone Number</label>
                {{ form.phone(class="form-control", required=True) }}
            </div>

            <h5>Billing Address</h5>
            <div class="form-group">
                <label for="address_line1">Address Line 1</label>
                {{ form.address_line1(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="city">City</label>
                {{ form.city(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="country">Country</label>
                {{ form.country(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="postcode">Postcode</label>
                {{ form.postcode(class="form-control", required=True) }}
            </div>

            <button type="button" class="next-btn" onclick="nextStep('personal-info', 'payment-info')">Next</button>
        </div>

        <!-- Step 2: Payment Info -->
        <div id="payment-info" class="step-section hidden">
            <h4>Enter Payment Details</h4>

            <div class="form-group">
                <label for="card_number">Card Number</label>
                <input type="text" name="card_number" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="expiry_date">Expiry Date</label>
                <input type="text" name="expiry_date" class="form-control" placeholder="MM/YY" required>
            </div>
            <div class="form-group">
                <label for="cvv">CVV</label>
                <input type="text" name="cvv" class="form-control" required>
            </div>

            <div class="form-group promo-code">
                <label for="promo-code">Promo Code (Optional)</label>
                <input type="text" id="promo-code" class="form-control" placeholder="Enter promo code">
                <button type="button" onclick="applyPromoCode()">Apply</button>
                <p id="promo-message"></p>
            </div>

            <button type="button" class="next-btn" onclick="nextStep('payment-info', 'password-info')">Next</button>
        </div>

        <!-- Step 3: Password Info -->
        <div id="password-info" class="step-section hidden">
            <h4>Set Your Account Password</h4>
            <div class="form-group">
                <label for="password">Password</label>
                {{ form.password(class="form-control", required=True) }}
            </div>
            <div class="form-group">
                <label for="confirm_password">Confirm Password</label>
                {{ form.confirm_password(class="form-control", required=True) }}
            </div>

            <button type="submit" class="submit-btn">Complete Registration</button>
        </div>
    </form>
</div>
{% endif %}

<!-- âœ… Funny Success Message (Shows Only After Success) -->
{% if show_success %}
<div class="success-message show" id="success-message"
    style="text-align: center; margin: auto; max-width: 600px; padding: 20px;">
    <h2>ðŸŽ‰ Woohoo! Youâ€™re now officially part of the Brainery Family! ðŸŽ“</h2>
    <p>ðŸ“¬ Check your email for your account activation link.</p>
    <p>ðŸ¤– If you donâ€™t see it, maybe itâ€™s lost in the <strong>Matrix</strong> (or spam folder).</p>
    <p>ðŸš€ Happy Learning!</p>
</div>
{% endif %}



<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("JavaScript Loaded! Waiting for user interaction...");

        /* =======================================================
           âœ… SECTION 1: Element Selection
        ======================================================= */
        let packages = document.querySelectorAll(".package");
        let selectedPlanInput = document.getElementById("selected_plan");
        let personalInfo = document.getElementById("personal-info");
        let paymentForm = document.getElementById("payment-info");
        let passwordInfo = document.getElementById("password-info");
        let submitButton = document.querySelector("#password-info .submit-btn");
        let successMessage = document.getElementById("success-message");
        let registerForm = document.getElementById("register-form");
        let nextButton = document.querySelector("#payment-info .next-btn");
        let errorMessageBox = document.getElementById("error-message-box");

        let cardNumber = document.querySelector('input[name="card_number"]');
        let expiryDate = document.querySelector('input[name="expiry_date"]');
        let cvv = document.querySelector('input[name="cvv"]');
        let promoCodeInput = document.getElementById("promo-code");
        let promoMessage = document.getElementById("promo-message");

        /* =======================================================
           âœ… SECTION 2: Reset Form on Page Reload
        ======================================================= */
        window.addEventListener("load", function () {
            console.log("Resetting form on page reload...");
            document.getElementById("registration-form")?.reset();
        });

        /* =======================================================
           âœ… SECTION 3: Hide Registration Form After Successful Submission
        ======================================================= */
        if (successMessage && successMessage.classList.contains("show")) {
            console.log("Registration successful! Hiding the form...");
            registerForm.style.display = "none";
        }

        /* =======================================================
           âœ… SECTION 4: Package Selection Handling
        ======================================================= */
        packages.forEach(package => {
            package.addEventListener("click", function () {
                console.log("Package Selected:", this.dataset.name);

                packages.forEach(p => p.classList.remove("selected"));
                this.classList.add("selected");

                selectedPlanInput.value = `${this.dataset.name} - Â£${this.dataset.price}`;
                console.log("Selected Plan:", selectedPlanInput.value);

                personalInfo.style.display = "block";
                setTimeout(() => { personalInfo.style.opacity = 1; }, 100);
                personalInfo.scrollIntoView({ behavior: "smooth" });
            });
        });

        /* =======================================================
           âœ… SECTION 5: Field Validation & Error Handling
        ======================================================= */
        function showError(input, message) {
            let errorSpan = input.parentElement.querySelector(".error-message");
            if (!errorSpan) {
                errorSpan = document.createElement("span");
                errorSpan.classList.add("error-message");
                errorSpan.style.color = "red";
                input.parentElement.appendChild(errorSpan);
            }
            errorSpan.innerText = message;
            input.style.border = "2px solid red";
        }

        function clearErrors() {
            document.querySelectorAll(".error-message").forEach(el => el.remove());
            document.querySelectorAll("input").forEach(el => el.style.border = "");
        }

        /* =======================================================
           âœ… SECTION 6: Step Navigation & Validation (Next Button)
        ======================================================= */
        function nextStep(currentId, nextId) {
            let currentSection = document.getElementById(currentId);
            let nextSection = document.getElementById(nextId);

            if (!currentSection || !nextSection) {
                console.error("ERROR: Missing section IDs", currentId, nextId);
                return;
            }

            clearErrors();

            let requiredFields = currentSection.querySelectorAll("input[required]");
            let emptyFields = Array.from(requiredFields).filter(input => input.value.trim() === "");

            let isPromoApplied = promoCodeInput.value.trim() === "CI25MP3";

            // âœ… Skip validation of card fields if promo is applied
            if (isPromoApplied && currentId === "payment-info") {
                emptyFields = emptyFields.filter(input => !["card_number", "expiry_date", "cvv"].includes(input.name));
            }

            if (emptyFields.length > 0) {
                emptyFields.forEach(input => showError(input, "âš ï¸ This field is required."));
                emptyFields[0].focus();
                return;
            }

            console.log(`Transitioning from ${currentId} to ${nextId}`);

            // Hide current section
            currentSection.style.opacity = 0;
            setTimeout(() => {
                currentSection.style.display = "none";
                nextSection.style.display = "block";
                setTimeout(() => { nextSection.style.opacity = 1; }, 100);
                nextSection.scrollIntoView({ behavior: "smooth" });
            }, 200);
        }

        window.nextStep = nextStep;

        /* =======================================================
           âœ… SECTION 7: Expiry Date Validation (March 2025 & Onwards)
        ======================================================= */
        function validateExpiryDate(expiryDate) {
            let [month, year] = expiryDate.split("/").map(Number);
            return !(isNaN(month) || isNaN(year) || month < 1 || month > 12 || year < 25 || (year === 25 && month < 3));
        }

        /* =======================================================
           âœ… SECTION 8: Payment Form Submission & Validation
        ======================================================= */
        paymentForm.addEventListener("submit", function (event) {
            event.preventDefault();
            console.log("ðŸ’³ Processing Payment...");

            clearErrors();

            let isPromoApplied = promoCodeInput.value.trim() === "CI25MP3";

            if (!isPromoApplied) {
                if (!validateExpiryDate(expiryDate.value.trim())) {
                    showError(expiryDate, "âŒ Expiry date must be March 2025 (03/25) or later.");
                    return;
                }
                if (!cardNumber.value.trim()) {
                    showError(cardNumber, "âŒ Card number is required.");
                    return;
                }
                if (!cvv.value.trim()) {
                    showError(cvv, "âŒ CVV is required.");
                    return;
                }
            }

            console.log("âœ… Payment Validated. Moving to Password Section...");
            nextStep("payment-info", "password-info");
        });

        /* =======================================================
           âœ… SECTION 9: Promo Code Handling (Fully Fixed)
        ======================================================= */
        function applyPromoCode() {
            let promoCodeValue = promoCodeInput.value.trim();
            let isValidPromo = promoCodeValue === "CI25MP3";

            if (isValidPromo) {
                promoMessage.innerText = "âœ… Promo applied! No payment required.";
                promoMessage.style.color = "green";

                // âœ… Disable card input fields, clear them, and allow Next button
                [cardNumber, expiryDate, cvv].forEach(field => {
                    field.disabled = true;
                    field.style.backgroundColor = "#e9ecef";
                    field.value = "";
                    field.removeAttribute("required"); // Remove required when promo is applied
                });

                nextButton.disabled = false;
            } else {
                promoMessage.innerText = "âŒ Invalid promo code.";
                promoMessage.style.color = "red";

                // âœ… Re-enable card input fields and set them as required again
                [cardNumber, expiryDate, cvv].forEach(field => {
                    field.disabled = false;
                    field.style.backgroundColor = "";
                    field.setAttribute("required", "true"); // Reapply required when promo is removed
                });

                nextButton.disabled = true;
            }
        }

        promoCodeInput.addEventListener("input", function () {
            if (!promoCodeInput.value.trim()) {
                [cardNumber, expiryDate, cvv].forEach(field => {
                    field.disabled = false;
                    field.style.backgroundColor = "";
                    field.setAttribute("required", "true");
                });

                nextButton.disabled = true;
                promoMessage.innerText = "";
            }
        });

        document.querySelector(".promo-code button")?.addEventListener("click", applyPromoCode);
    });
</script>

{% endblock %}